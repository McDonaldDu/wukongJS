<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Wukong JS</title>
    
    <style>
      button.control {
        width: 80px;
        height: 40px;
        font-family: monospace;
        font-size: 18px;
        font-weight: bold;
      }
      
      select.options {
        height: 40px;
        font-family: monospace;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <h4 align="center" style="margin-top: 50px;">Wukong JS - UCI chess engine by Code Monkey King</h4>
    
    <!-- Chess board view -->
    <div id="chessboard"></div>
    
    <!-- Controls -->
    <div align="center" style="margin-top: 10px;">
      <select id="movetime" class="options">
        <option value="1">1s</option>
        <option value="2">2s</option>
        <option value="3">3s</option>
        <option value="4">4s</option>
        <option value="5">5s</option>
        <option value="6">6s</option>
        <option value="7">7s</option>
        <option value="8">8s</option>
        <option value="9">9s</option>
      </select>
      <button class="control" onclick="newGame();">New</button>
      <button class="control" onclick="think();">Move</button>
      <button class="control" onclick="undo();">Undo</button>
      <button class="control" onclick="flip()">Flip</button>
      <select id="promoted" class="options">
        <option value="5">♛</option>
        <option value="4">♜</option>
        <option value="3">♝</option>
        <option value="2">♞</option>
      </select>
    </div>

    <!-- Chess board script -->
    <script src="wukong.js"></script>

    <!-- User input handling -->
    <script>
      // run in browser mode  
      console.log('\n  Wukong JS - BROWSER MODE - v' + VERSION);
      console.log('  type "engine" for public API reference');

      // init engine
      var engine = new Engine();

      /****************************\
       ============================
     
              GUI EVENT BINDS

       ============================              
      \****************************/
      
      // user input controls
      var clickLock = 0;
      var userSource, userTarget;
        
      // pick piece handler
      function dragPiece(event, square) { userSource = square; }
      
      // drag piece handler
      function dragOver(event, square) { event.preventDefault();
        if (square == userSource) event.target.src = 'Images/0.gif';
      }
      
      // drop piece handler
      function dropPiece(event, square) {
        userTarget = square;
        let promotedPiece = parseInt(document.getElementById('promoted').value);
        promotedPiece = (engine.getSide() ? (promotedPiece + 6): promotedPiece)
        let valid = validateMove(userSource, userTarget, promotedPiece);
        engine.movePiece(userSource, userTarget, promotedPiece); 
        clickLock = 0;
        
        if (engine.getPiece(square))
          document.getElementById(square).style.backgroundColor = engine.SELECT_COLOR;
        
        event.preventDefault();
        if (valid) setTimeout(function() { think() }, 1);
      }
      
      // click event handler
      function tapPiece(square) {
        engine.drawBoard();
        engine.updateBoard();
        
        if (engine.getPiece(square)) 
          document.getElementById(square).style.backgroundColor = engine.SELECT_COLOR;
        
        var clickSquare = parseInt(square, 10)
        
        if(!clickLock && engine.getPiece(clickSquare)) {      
          userSource = clickSquare;
          clickLock ^= 1;
        } else if(clickLock) {      
          userTarget = clickSquare;
          
          let promotedPiece = parseInt(document.getElementById('promoted').value);
          promotedPiece = (engine.getSide() ? (promotedPiece + 6): promotedPiece)
          let valid = validateMove(userSource, userTarget, promotedPiece);
          engine.movePiece(userSource, userTarget, promotedPiece);
          clickLock = 0;
          
          if (engine.getPiece(square))
            document.getElementById(square).style.backgroundColor = engine.SELECT_COLOR;

          if (valid) setTimeout(function() { think() }, 1);
        }
      }
      
      // validate move
      function validateMove(userSource, userTarget, promotedPiece) {
        let moveString = engine.squareToString(userSource) + 
                         engine.squareToString(userTarget) +
                         engine.promotedToString(promotedPiece);

        let move = engine.isValid(moveString);
        return move;
      }
      
      // start new game
      function newGame() {
        engine.setBoard(engine.START_FEN);
      }
      
      // take move back
      function undo() {
        
        engine.takeBack();
        
        engine.drawBoard();
        engine.updateBoard();
      }
      
      // flip board
      function flip() {
        engine.flipBoard();
        engine.drawBoard();
        engine.updateBoard();
      }
      
      // engine move
      function think() {
        engine.drawBoard();
        engine.updateBoard();

        let bestMove = engine.search(5);
        let sourceSquare = engine.getMoveSource(bestMove);
        let targetSquare = engine.getMoveTarget(bestMove);
        let promotedPiece = engine.getMovePromoted(bestMove);
        engine.movePiece(sourceSquare, targetSquare, promotedPiece);
        
        if (engine.getPiece(targetSquare))
          document.getElementById(targetSquare).style.backgroundColor = engine.SELECT_COLOR;
      }
    </script>
  </body>
<html>
